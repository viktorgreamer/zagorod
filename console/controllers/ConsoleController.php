<?php
/**
 * Created by PhpStorm.
 * User: Анастсия
 * Date: 02.12.2018
 * Time: 10:29
 */

namespace console\controllers;

use common\models\Table;
use common\models\TableCells;
use common\models\TableHistory;
use common\models\Works;
use Yii;
use backend\utils\D;
use common\models\Evaluator;

class ConsoleController extends \yii\console\Controller
{

    public function beforeAction($action)
    {
        \backend\utils\D::$isConsole = true;
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionToggleClasses()
    {

        $cell = \common\models\TableCells::findOne(45);
        $cell->toggleClass('text-color-red');
        // $cell->toggleClass('text-color-red');
        $cell->toggleClass('text-center');
        $cell->toggleClass('text-9center');
        D::success($cell->classes);
    }

    public function actionTestInversion()
    {
        if ((1) && (1)) echo "TRUE";
        $result = Evaluator::makeBoolean('(1) && (1)');
        D::dump("VALUE = " . $result['value']);
        D::dump($result['type']);
        //  D::dump(eval("!1"));
    }

    public function actionLogDatabase()
    {
        $timestart = time();
        foreach (range(1, 10) as $step) {

            TableHistory::storeNew();

            sleep(2);

        }

        TableHistory::ClearOld();


        D::success("SCRIPTS TAKES " . (time() - $timestart - 20) . " WITH RESPONSE ");


    }

    public function actionLoadWorks()
    {
        $file = "Монтаж в котлован	------	шт.	------		------	
Пусконаладочные работы	------	шт.	------		------	
Монтаж без земляных работ: контроль выполнения земляных работ, погружение станции (с помощью рабочей силы заказчика), подключение электрики, насосного оборудования, вваривание патрубков, монтаж аварийной сигнализации, контроль прокладки труб и ввода в дом**	------	шт.	------		------	
Прокладка канализационной трубы под уклон (ввод в станцию и выброс)              	------	м	------	500	------	150
Монтаж инфильтрационного колодца 1,5 м	------	шт.	------	4 500	------	1000
Монтаж инфильтрационного колодца 2 м	------	шт.	------	5 500	------	1000
Перемещение грунта	------	м*куб м	------	30	------	10
Перемещение песка (расстояние более 20 м)	------	м*куб м	------	30	------	10
Перемещение щебня (расстояние более 20 м)	------	м*куб м	------	30	------	10
Вваривание дополнительного входа в станцию	------	шт.	------	1 500	------	375
Проход деревянного пола	------	шт.	------	1 000	------	250
Проход плитки	------	шт.	------	2 400	------	600
Проход газобетонной стены	------	шт.	------	1 200	------	300
Проход стены из кирпича	------	шт.	------	2 000	------	500
Монтаж ревизии	------	шт.	------	1 000	------	250
Утепление канализационной трубы 	------	м	------	50	------	13
Шурфование	------	шт.	------	2 000	------	500
Перемещение демонтированного бетонного кольца	------	м*шт.	------	30	------	10
Прокладка трубы 25 мм на выброс 	------	м	------	300	------	150
Подкоп под фундамент  	------	шт.	------	2 000	------	500
Переделка (поднятие) вывода	------	шт.	------	4 000	------	2000
Прокладка трубы на выброс с греющим кабелем	------	м	------	300	------	150
Прокладка кабеля в земле, отдельно от основной траншеи	------	м	------	150	------	50
Подрубка корней кл 1 (пни деревьев)	------	шт.	------	2 500	------	2000
Подрубка корней кл 2 (корневая система деревьев)	------	шт.	------	1 500	------	1000
Подрубка корней кл 3 (кустарники)	------	шт.	------	1 000	------	0
Укладка гильзы из трубы асбестоцементной	------	шт.	------	2 000	------	500
Погрузка грунта на самосвал	------	куб м	------	750	------	500
Вывоз и утилизация грунта	------	ходка	------	8 000	------	7000
Подключение кабеля в щиток	------	шт.	------	500	------	125
Работа генератора с учетом доставки и расхода ГСМ	------	день	------		------	
Отводящая канава (глубина 40-50 см)	------	м	------	300	------	100
Демонтаж ж/б кольца колодца без сохранения целостности	------	шт.	------	3 000	------	750
Монтаж КНС 1,5 м	------	шт.	------	4500	------	3625
Монтаж КНС 2 м	------	шт.	------	5500	------	3875
Монтаж КНС 2,5 м	------	шт.	------	8000	------	4500
Монтаж КНС 3 м	------	шт.	------	9500	------	4875
Монтаж сборного колодца 1,5 м	------	шт.	------	4500	------	3625
Монтаж сборного колодца 2 м	------	шт.	------	5500	------	3875
Монтаж сборного колодца 2,5 м	------	шт.	------	8000	------	4500
Монтаж сборного колодца 3 м	------	шт.	------	9500	------	4875
Установка насоса	------	шт.	------	3000	------	750
Сборка и монтаж выносного электрического блока	------	шт.	------	2000	------	500
Проход стенки пластикого колодца	------	шт.	------	400	------	100
Якорение септика (Росток Мини или Дачный)	------	шт.	------	3000	------	2000
Якорение септика (Росток Загородный или Коттеджный)	------	шт.	------	5000	------	2000
Приготовление ЦПС	------	куб м	------	600	------	0
Прокладка ПНД 50 мм от КНС до септика	------	м	------	500	------	150
Прокладка канализационной трубы (подвес)	------	м	------	350	------	88
Монтаж сливного клапана	------	шт.	------	500	------	125
Монтаж скважинного насоса	------	шт.	------	5 000	------	1250
Монтаж скважинного адаптера	------	шт.	------	4 500	------	1125
Прокладка трубы ниже глубины промерзания     	------	м	------	900	------	225
Ввод в дом, монтаж греющего кабеля	------	шт.	------	2 000	------	500
Монтаж поливочного крана из дома 	------	шт.	------	1 950	------	488
Монтаж фильтра	------	шт.	------	1 250	------	313
Монтаж кранов шаровых	------	шт.	------	650	------	163
Установка реле защиты от сухого хода	------	шт.	------	1 850	------	463
Монтаж гидроаккумулятора и подключение автоматики	------	шт.	------	4 000	------	1000
Монтаж насосной станции	------	шт.	------	3 500	------	875
Проход стенки ж/б колодца	------	шт.	------	1 000	------	250
Монтаж колодезного насоса	------	шт.	------	5000	------	1250
Монтаж гидроаккумулятора 	------	шт.	------	2 500	------	625";
        if ($rows = explode("\n", $file)) {
            foreach ($rows as $row) {
                $params = preg_split("/------/", $row);
                //  D::dump($params);
                $work = new Works();
                $work->name = trim($params[0]);
                $work->ei = trim($params[1]);
                $work->cost = preg_replace("/\s/", '', trim($params[2]));
                $work->self_cost = preg_replace("/\s/", '', trim($params[3]));
                D::dump($work->toArray());
                if (!$work->save()) D::dump($work->errors);

            }
        }
        //   D::dump($rows);
    }

    public function actionRestore()
    {
        $tableHistory = TableHistory::findOne(26);
        // TableHistory::storeNew();
        $tableHistory->restore();
    }

    public function actionRenameEi()
    {
        if ($tableCells = TableCells::find()->all()) {
            foreach ($tableCells as $tableCell) {
                if (preg_match("/meisure/", $tableCell->value)) {
                    $tableCell->value = preg_replace("/meisure/", 'ei', $tableCell->value);
                    D::success($tableCell->value);
                    $tableCell->save();
                }
            }
        }

    }

    public function actionGenerateAddresses()
    {
        foreach (TableCells::find()->All() as $cell) {
            $cell->address = $address = $cell->generateAddress();

            D::success(" ADDRESS FOR " . $cell->tr_id . " " . $cell->td_id . " = " . $cell->address);
            if (!$cell->save()) D::dump($cell->errors);

        }
    }

    public function actionTestRows()
    {
        D::success(" WE ARE TESTING ROWS");
        $tableCell = new TableCells();
        $width = 35;

        // $tableCell->value = " Этот текст надо перенести, если что, но можно и не переносить";
        $tableCell->value = "Мой скрипт используется не только на моём локальном сервере, но и на сервере хостинга, а установить что-либо на него мне не представляется возможным.";

        $countChars = strlen($tableCell->value);
        $words = preg_split("/\s/", $tableCell->value);
        $countWords = count($words);
        $sense = [];
        $string = [];
        $countRows = 1;
        foreach ($words as $key => $word) {

            if (mb_strlen(implode(" ", $string) . " " . $word) > $width) {
                D::alert(" LEN  = " . mb_strlen(implode(" ", $string) . " " . $word));
                //  D::primary($string);
                $sense[] = implode(" ",$string);
                $string = [];
                $string[] = $word;
                $countRows++;

            } else {
                $string[] = $word;
            }

        }
        $sense[] = implode(" ",$string);
       // D::dump($sense);
         echo implode("\n",$sense);
        echo "\n";
        D::success(" COUNT CHARS = " . $countChars);
        D::success(" COUNT WORDS = " . $countWords);
        D::success(" COUNT ROWS = " . TableCells::countRows($tableCell->value, $width));

    }

}